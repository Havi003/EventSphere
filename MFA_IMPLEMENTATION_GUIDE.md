# Multi-Factor Authentication (MFA) Implementation Guide

## Overview
This guide explains how to use the Multi-Factor Authentication (2FA) system implemented in EventSphere using ASP.NET Core Identity and authenticator apps.

## What Has Been Implemented

### 1. Core MFA Components
- **QRCoder Package**: Installed for generating QR codes
- **Program.cs**: Configured to support authenticator token provider
- **Login Flow**: Updated to redirect to 2FA verification when enabled

### 2. MFA Setup Pages
- **EnableAuthenticator**: Setup page for configuring authenticator app
- **ShowRecoveryCodes**: Displays recovery codes after MFA setup
- **TwoFactorAuthentication**: Main management page for 2FA settings

### 3. Login Pages
- **LoginWith2fa**: Verification page during login
- **LoginWithRecoveryCode**: Alternative login using recovery codes
- **Lockout**: Page shown when account is locked

### 4. Management Pages
- **Disable2fa**: Disable two-factor authentication
- **GenerateRecoveryCodes**: Generate new recovery codes
- **ResetAuthenticator**: Reset authenticator key

### 5. UI Integration
- Added "Security Settings" section to user profile
- Links to Change Password and Two-Factor Authentication

## How to Use MFA

### For Users - Enabling MFA

1. **Navigate to Profile**
   - Log in to your account
   - Click on your username in the navigation bar
   - Go to your profile page

2. **Access Two-Factor Authentication**
   - In the "Security Settings" section
   - Click on "Two-Factor Authentication"

3. **Setup Authenticator App**
   - Click "Add authenticator app" or "Setup authenticator app"
   - Download an authenticator app if you don't have one:
     - **Microsoft Authenticator** (iOS/Android)
     - **Google Authenticator** (iOS/Android)
     - **Authy** (iOS/Android/Desktop)

4. **Scan QR Code**
   - Open your authenticator app
   - Scan the QR code displayed on the screen
   - Alternatively, manually enter the key shown

5. **Verify Setup**
   - Enter the 6-digit code from your authenticator app
   - Click "Verify"

6. **Save Recovery Codes**
   - **IMPORTANT**: Save the recovery codes in a safe place
   - You'll need these if you lose access to your authenticator app
   - Store them securely (password manager, encrypted file, etc.)

### For Users - Logging In with MFA

1. **Enter Username and Password**
   - Go to the login page
   - Enter your username and password as usual

2. **Enter 2FA Code**
   - You'll be redirected to the 2FA verification page
   - Open your authenticator app
   - Enter the current 6-digit code
   - Optionally check "Remember this machine" to skip 2FA on this device

3. **Alternative: Use Recovery Code**
   - If you don't have access to your authenticator app
   - Click "log in with a recovery code"
   - Enter one of your saved recovery codes
   - **Note**: Each recovery code can only be used once

### For Users - Managing MFA

#### Disable 2FA
1. Go to Profile → Security Settings → Two-Factor Authentication
2. Click "Disable 2FA"
3. Confirm the action

#### Generate New Recovery Codes
1. Go to Profile → Security Settings → Two-Factor Authentication
2. Click "Reset recovery codes"
3. Save the new codes securely

#### Reset Authenticator App
1. Go to Profile → Security Settings → Two-Factor Authentication
2. Click "Reset authenticator app"
3. This will disable 2FA and require you to set it up again

#### Forget This Browser
1. Go to Profile → Security Settings → Two-Factor Authentication
2. Click "Forget this browser"
3. You'll need to enter 2FA code on next login from this browser

## Security Best Practices

### For Users
1. **Keep Recovery Codes Safe**
   - Store them in a password manager
   - Keep a physical copy in a secure location
   - Never share them with anyone

2. **Use a Reliable Authenticator App**
   - Microsoft Authenticator (recommended)
   - Google Authenticator
   - Authy (has cloud backup feature)

3. **Enable 2FA on Important Accounts**
   - Especially for accounts with event management privileges
   - Protects against password theft

4. **Don't Share Your 2FA Codes**
   - Codes are time-sensitive and unique to you
   - EventSphere will never ask for your 2FA code

### For Developers
1. **Recovery Codes**
   - 10 recovery codes are generated by default
   - Each code can only be used once
   - Users should generate new codes periodically

2. **Lockout Protection**
   - Currently set to `lockoutOnFailure: false`
   - Consider enabling lockout for production

3. **Token Expiration**
   - Authenticator codes expire every 30 seconds
   - Recovery codes don't expire

## Troubleshooting

### "Invalid authenticator code" Error
- **Cause**: Code expired or incorrect
- **Solution**: Wait for a new code and try again
- **Check**: Ensure your device's time is synchronized

### Lost Access to Authenticator App
- **Solution**: Use a recovery code to log in
- **Then**: Reset your authenticator app and set up a new one

### No Recovery Codes Left
- **Prevention**: Generate new codes before running out
- **If locked out**: Contact system administrator

### QR Code Not Displaying
- **Check**: Browser JavaScript is enabled
- **Alternative**: Use the manual key entry method

## Technical Details

### Authentication Flow
```
1. User enters username/password
2. System validates credentials
3. If 2FA enabled → Redirect to LoginWith2fa
4. User enters authenticator code
5. System validates code
6. If valid → Login successful
7. If invalid → Show error, allow retry
```

### Database Changes
- No database migrations required
- ASP.NET Identity handles 2FA data automatically
- User table already has necessary fields:
  - `TwoFactorEnabled`
  - `AuthenticatorKey`
  - Recovery codes stored separately

### API Endpoints
- `/Identity/Account/Manage/TwoFactorAuthentication` - Main 2FA page
- `/Identity/Account/Manage/EnableAuthenticator` - Setup page
- `/Identity/Account/LoginWith2fa` - Verification during login
- `/Identity/Account/LoginWithRecoveryCode` - Recovery code login

## Testing MFA

### Test Scenario 1: Enable MFA
1. Log in with a test account
2. Navigate to Profile → Security Settings → Two-Factor Authentication
3. Click "Add authenticator app"
4. Scan QR code with authenticator app
5. Enter verification code
6. Save recovery codes
7. Verify 2FA is enabled

### Test Scenario 2: Login with MFA
1. Log out
2. Log in with username/password
3. Verify redirect to 2FA page
4. Enter code from authenticator app
5. Verify successful login

### Test Scenario 3: Recovery Code Login
1. Log out
2. Log in with username/password
3. Click "log in with a recovery code"
4. Enter a recovery code
5. Verify successful login

### Test Scenario 4: Disable MFA
1. Go to Two-Factor Authentication page
2. Click "Disable 2FA"
3. Log out and log in
4. Verify no 2FA prompt

## Next Steps

### Optional Enhancements
1. **SMS 2FA**: Add SMS-based 2FA as alternative
2. **Email 2FA**: Add email-based 2FA
3. **Backup Codes**: Allow users to download codes as file
4. **2FA Statistics**: Show when 2FA was last used
5. **Trusted Devices**: Manage list of remembered devices

### Production Considerations
1. Enable account lockout after failed attempts
2. Add email notifications for 2FA changes
3. Implement audit logging for security events
4. Consider requiring 2FA for admin accounts
5. Add rate limiting for 2FA verification attempts

## Support

If you encounter any issues with MFA:
1. Check this guide first
2. Verify your authenticator app time is synchronized
3. Try using a recovery code
4. Contact system administrator if locked out

---

**Last Updated**: October 1, 2025
**Version**: 1.0
**Framework**: ASP.NET Core 8.0
**Identity Version**: Microsoft.AspNetCore.Identity
